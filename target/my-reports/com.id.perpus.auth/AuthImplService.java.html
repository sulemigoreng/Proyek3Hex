<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AuthImplService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">PerpustakaanWebApp</a> &gt; <a href="index.source.html" class="el_package">com.id.perpus.auth</a> &gt; <span class="el_source">AuthImplService.java</span></div><h1>AuthImplService.java</h1><pre class="source lang-java linenums">package com.id.perpus.auth;

import java.io.IOException;
import java.util.Date;
import java.util.List;
import java.util.concurrent.LinkedBlockingQueue;
import java.util.concurrent.TimeUnit;

import javax.sql.DataSource;

import org.apache.tomcat.util.threads.ThreadPoolExecutor;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.id.perpus.common.Common;
import com.id.perpus.common.Constanta;
import com.id.perpus.common.Mail;
import com.id.perpus.common.Messages;
import com.id.perpus.common.Response;
import com.id.perpus.user.UserModel;
import com.id.perpus.user.UserRepository;

@Service
<span class="fc" id="L26">public class AuthImplService implements AuthService{</span>

<span class="fc" id="L28">	private final Logger logger = LoggerFactory.getLogger(AuthImplService.class);</span>
	
	@Autowired
	Messages messages;
	
	@Autowired
	DataSource dataSource;

	@Autowired
	private LoginRepository loginRepository;
	
	@Autowired
	private UserRepository userRepository;
	
	@Autowired
	private Mail mailer;
	
	public Response doLogin(String username, String password) {
		try {
<span class="nc" id="L47">			UserModel dto = new UserModel();</span>
<span class="nc" id="L48">			dto.setUsername(username);</span>
<span class="nc" id="L49">			dto.setEmail(username);</span>
<span class="nc" id="L50">			dto.setPassword(Common.MD5(password));</span>
			
<span class="nc" id="L52">			List&lt;UserModel&gt; login = loginRepository.doLogin(dto);</span>
<span class="nc bnc" id="L53" title="All 4 branches missed.">			if(login != null &amp;&amp; login.size() &gt; 0){</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">				if(login.get(0).getStatus().equals(&quot;ST1&quot;)){</span>
<span class="nc" id="L55">					return new Response(Constanta.SUCCESS,&quot;&quot;,&quot;&quot;,null);</span>
				}else{
<span class="nc" id="L57">					return new Response(Constanta.FAILED,messages.find(&quot;message.MSTD0000AERR&quot;,&quot;USER NON ACTIVE&quot;),&quot;MSTD0000AERR&quot;,null);</span>
				}
			}else{
<span class="nc" id="L60">				return new Response(Constanta.FAILED,messages.find(&quot;message.MSTD0043AERR&quot;,&quot;user name or password&quot;),&quot;MSTD0043AERR&quot;,null);</span>
			}
<span class="nc" id="L62">		} catch (Exception e) {</span>
<span class="nc" id="L63">			logger.error(e.getMessage(), e);</span>
<span class="nc" id="L64">			return new Response(Constanta.FAILED,messages.find(&quot;message.MSTD0043AERR&quot;,&quot;user name or password&quot;),&quot;MSTD0043AERR&quot;,null);</span>
		}
	}

	@Override
	public Response doForgot(String insertemail) {
		try {
<span class="nc" id="L71">			String password = Common.generatePassword();</span>
//			String password = Constanta.PASSWORD_DEFAULT;
<span class="nc" id="L73">			UserModel dto = new UserModel();</span>
<span class="nc" id="L74">			dto.setPassword(Common.MD5(password));</span>
<span class="nc" id="L75">			dto.setEmail(insertemail);</span>
<span class="nc" id="L76">			dto.setUpdatedBy(&quot;System&quot;);</span>
<span class="nc" id="L77">			dto.setUpdatedDt(Constanta.sdf.format(new Date()));</span>
<span class="nc" id="L78">			int update = userRepository.doUpdatePassword(dto);</span>
<span class="nc" id="L79">			List&lt;UserModel&gt; dataUser = userRepository.doSearchByUsername(insertemail);</span>
<span class="nc bnc" id="L80" title="All 4 branches missed.">			if(update &gt; 0 &amp;&amp; dataUser.size()&gt;0){</span>
<span class="nc" id="L81">				ThreadPoolExecutor executor = new ThreadPoolExecutor(50, 50, 30, TimeUnit.SECONDS, new LinkedBlockingQueue&lt;Runnable&gt;());</span>
<span class="nc" id="L82">		        executor.execute(new Runnable() {</span>
		            @Override
		            public void run() {
		                try {
<span class="nc" id="L86">		                	StringBuilder body = new StringBuilder();</span>
<span class="nc" id="L87">		                	body.append(&quot;&lt;b&gt;Hello &quot; + dataUser.get(0).getName() + &quot;&lt;/b&gt;&lt;br&gt;&quot;)</span>
<span class="nc" id="L88">		                	    .append(&quot;&lt;br&gt;&quot;)</span>
<span class="nc" id="L89">		                	    .append(&quot;We heard you need new password because you forgot current password &lt;br&gt;&quot;)</span>
<span class="nc" id="L90">		                	    .append(&quot;Here, new password to use web PERPUS POLBAN &lt;br&gt;&quot;)</span>
<span class="nc" id="L91">		                	    .append(&quot;&lt;br&gt;&quot;)</span>
<span class="nc" id="L92">		                	    .append(&quot;&lt;h2 style='margin-left:4em'&gt;&lt;b&gt;&quot; + password + &quot;&lt;/b&gt;&lt;/h2&gt;&quot;)</span>
<span class="nc" id="L93">		                	    .append(&quot;&lt;br&gt;&quot;)</span>
<span class="nc" id="L94">		                	    .append(&quot;link web application : http://localhost:8080/PerpustakaanWebApp&lt;br&gt;&quot;);</span>
		                	    
<span class="nc" id="L96">		                	mailer.send(insertemail, Constanta.EMAIL_SUBJECT,body.toString());</span>
<span class="nc" id="L97">		                } catch (IOException e) {</span>
<span class="nc" id="L98">		                    logger.error(e.getMessage(), e);</span>
<span class="nc" id="L99">		                } catch (Exception e) {</span>
<span class="nc" id="L100">		                	logger.error(e.getMessage(), e);</span>
						}
<span class="nc" id="L102">		            }</span>
		        });
<span class="nc" id="L104">				return new Response(Constanta.SUCCESS,messages.find(&quot;message.MSTD0000AINF&quot;,&quot;Kata sandi baru anda telah terkirim ke email&quot;),&quot;MSTD0000AINF&quot;,null);</span>
			}
			
<span class="nc" id="L107">			return new Response(Constanta.SUCCESS,messages.find(&quot;message.MSTD0000AERR&quot;,&quot;Email yang anda masukan tidak terdaftar&quot;),&quot;MSTD0000AERR&quot;,null);</span>
<span class="nc" id="L108">		} catch (Exception e) {</span>
<span class="nc" id="L109">			logger.error(e.getMessage(), e);</span>
<span class="nc" id="L110">			return new Response(Constanta.FAILED,messages.find(&quot;message.MSTD0000AERR&quot;,&quot;Terjadi kesalah ketika mengirim email&quot;),&quot;MSTD0000AERR&quot;,null);</span>
		}
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>